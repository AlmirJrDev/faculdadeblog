---
title: "Atividade 02 - Monitoramento de √înibus em Tempo Real"
author: "Seu Nome"
date: "2024-11-23"
categories: [python, api, mapas, geolocaliza√ß√£o]
image: "thumbnail.jpg"
---

## Objetivo

Criar um sistema de monitoramento em tempo real de √¥nibus da SPTrans utilizando a API Olho Vivo, com visualiza√ß√£o em mapa interativo.

## Tecnologias Utilizadas

- **Python 3.x**
- **requests**: Para autentica√ß√£o e requisi√ß√µes √† API
- **folium**: Para criar mapas interativos
- **API SPTrans Olho Vivo**: Dados de transporte p√∫blico de S√£o Paulo

## Arquitetura da Solu√ß√£o

### 1. Autentica√ß√£o

A API SPTrans exige autentica√ß√£o via POST com um token:

```python
def autenticar(self):
    """Autentica na API da SPTrans"""
    url = f"{self.base_url}/Login/Autenticar?token={self.token}"
    response = self.session.post(url)
    if response.text == "true":
        print("‚úì Autentica√ß√£o realizada com sucesso!")
```

**Importante**: A sess√£o autenticada deve ser mantida para todas as requisi√ß√µes subsequentes.

### 2. Classe MonitoramentoOnibus

Implementei uma classe para encapsular todas as funcionalidades:

```python
class MonitoramentoOnibus:
    def __init__(self, token):
        self.token = token
        self.session = requests.Session()
        self.base_url = "http://api.olhovivo.sptrans.com.br/v2.1"
        self.autenticar()
```

### 3. Busca de Linhas

Permite buscar linhas por termo de pesquisa:

```python
def buscar_linhas(self, termo_busca):
    """Busca linhas de √¥nibus por termo"""
    url = f"{self.base_url}/Linha/Buscar?termosBusca={termo_busca}"
    response = self.session.get(url)
    return response.json()
```

### 4. Obten√ß√£o de Dados em Tempo Real

Duas fun√ß√µes principais coletam dados:

#### Paradas da Linha
```python
def buscar_paradas(self, codigo_linha):
    """Busca paradas de uma linha espec√≠fica"""
    url = f"{self.base_url}/Parada/BuscarParadasPorLinha?codigoLinha={codigo_linha}"
    return self.session.get(url).json()
```

#### Posi√ß√µes dos Ve√≠culos
```python
def buscar_posicoes(self, codigo_linha):
    """Busca posi√ß√µes em tempo real dos √¥nibus"""
    url = f"{self.base_url}/Posicao/Linha?codigoLinha={codigo_linha}"
    return self.session.get(url).json()
```

### 5. Visualiza√ß√£o com Folium

O mapa interativo √© criado com diferentes marcadores:

```python
# Calcular centro do mapa (m√©dia das coordenadas)
lat_centro = sum(p['py'] for p in paradas) / len(paradas)
lon_centro = sum(p['px'] for p in paradas) / len(paradas)

# Criar mapa base
mapa = Map(
    location=[lat_centro, lon_centro],
    zoom_start=13,
    tiles='OpenStreetMap'
)
```

#### Marcadores de Paradas (Azul)
```python
Marker(
    location=[parada['py'], parada['px']],
    popup=f"<b>Parada: {parada['np']}</b><br>Endere√ßo: {parada['ed']}",
    icon=Icon(color='blue', icon='stop', prefix='fa')
).add_to(mapa)
```

#### Marcadores de √înibus (Vermelho)
```python
Marker(
    location=[veiculo['py'], veiculo['px']],
    popup=f"<b>üöå √înibus - Prefixo: {veiculo['p']}</b>",
    icon=Icon(color='red', icon='bus', prefix='fa')
).add_to(mapa)
```

### 6. Legenda Personalizada

Uma legenda HTML √© adicionada ao mapa:

```python
legenda_html = f'''
<div style="position: fixed; top: 10px; right: 10px; ...">
    <h4>Linha {nome_linha}</h4>
    <p><i class="fa fa-stop" style="color:blue"></i> Paradas: {len(paradas)}</p>
    <p><i class="fa fa-bus" style="color:red"></i> √înibus ativos: {len(veiculos)}</p>
    <p>Hor√°rio: {hora_consulta}</p>
</div>
'''
```

## Resultados

Para a linha **2780-10** (exemplo), obtivemos:

- **XX paradas** mapeadas
- **X √¥nibus** em circula√ß√£o no momento da consulta
- Dados atualizados em tempo real

### Mapa Interativo

[Clique aqui para visualizar o mapa completo](mapa_linha_2503.html)

**Legenda**:
- üîµ **Pins azuis**: Paradas da linha
- üî¥ **Pins vermelhos**: √înibus em circula√ß√£o

## C√≥digo Completo

```{python}
#| eval: false
#| code-fold: true
#| code-summary: "Ver c√≥digo completo"

import requests
import folium
from folium import Map, Marker, Icon
from datetime import datetime

TOKEN = "seu_token_aqui"

class MonitoramentoOnibus:
    # [C√≥digo completo da classe]
    pass

if __name__ == "__main__":
    monitor = MonitoramentoOnibus(TOKEN)
    linhas = monitor.buscar_linhas("Paulista")
    mapa = monitor.criar_mapa(codigo_linha=2503, nome_linha="2780-10")
```

## Desafios Encontrados

1. **Autentica√ß√£o**: A API exige manter a sess√£o autenticada
2. **Coordenadas**: Trabalhar com latitude e longitude (py, px)
3. **Dados em tempo real**: Os dados mudam constantemente
4. **Performance**: Minimizar chamadas √† API

## Aprendizados

1. **APIs com autentica√ß√£o**: Uso de sessions do requests
2. **Mapas interativos**: Biblioteca Folium e suas customiza√ß√µes
3. **Dados geoespaciais**: Trabalhar com coordenadas e visualiza√ß√µes
4. **HTML/CSS**: Criar elementos personalizados no mapa

## Poss√≠veis Melhorias

- Auto-atualiza√ß√£o do mapa a cada X segundos
- Filtros por regi√£o ou hor√°rio
- Hist√≥rico de posi√ß√µes (tracking)
- Previs√£o de chegada nas paradas
- Interface web completa com Flask/Django

---

**Reposit√≥rio**: [Link para o c√≥digo no GitHub](https://github.com/seu-usuario/seu-repo)